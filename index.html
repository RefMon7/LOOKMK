<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Candy Match Mobile</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    font-family: sans-serif;
    background: #2b2b2b;
    color: #fff;
    height: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

#info {
    display: flex;
    justify-content: space-around;
    width: 90%;
    margin-bottom: 10px;
    font-size: 1.2em;
}

#game {
    width: 90vw;
    max-width: 500px;
    aspect-ratio: 1;
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    grid-template-rows: repeat(8, 1fr);
    gap: 4px;
    background: #111;
    padding: 4px;
    border-radius: 10px;
    touch-action: none;
}

.cell {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    user-select: none;
    transition: transform 0.3s;
    cursor: pointer;
    background: linear-gradient(145deg, #ffb3b3, #ff6666);
}

.cell.swap {
    z-index: 2;
    transition: transform 0.3s ease-in-out;
}

.cell.match {
    animation: explode 0.3s forwards;
}

@keyframes explode {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.5); opacity: 0.7; }
    100% { transform: scale(0); opacity: 0; }
}

#message {
    margin-top: 15px;
    font-size: 1.2em;
    text-align: center;
}
</style>
</head>
<body>

<div id="info">
    <div>–°—á—ë—Ç: <span id="score">0</span></div>
    <div>–•–æ–¥—ã: <span id="moves">30</span></div>
    <div>–í—Ä–µ–º—è: <span id="timer">60</span> —Å</div>
</div>

<div id="game"></div>
<div id="message"></div>

<script>
const size = 8;
const candies = ['üç¨','üç≠','üç´','üç°','üç™'];
let grid = [];
let firstCell = null;
let score = 0;
let moves = 30;
let timer = 60;
let timerInterval;
let animating = false;

let touchStart = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
function init() {
    const game = document.getElementById("game");
    game.innerHTML = '';
    for (let i = 0; i < size * size; i++) {
        const div = document.createElement("div");
        div.className = "cell";
        div.dataset.index = i;
        game.appendChild(div);
    }
    fillGrid();
    render();
    updateInfo();
    startTimer();
    setupTouch();
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
function fillGrid() {
    grid = Array(size * size).fill().map(() => candies[Math.floor(Math.random() * candies.length)]);
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞
function render() {
    document.querySelectorAll(".cell").forEach((cell, i) => {
        cell.textContent = grid[i];
        cell.classList.remove('match', 'swap');
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
function updateInfo() {
    document.getElementById("score").textContent = score;
    document.getElementById("moves").textContent = moves;
    document.getElementById("timer").textContent = timer;
}

// –¢–∞–π–º–µ—Ä
function startTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timer--;
        updateInfo();
        if (timer <= 0) endGame();
    }, 1000);
}

// –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
function endGame() {
    document.getElementById("message").textContent = `–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í–∞—à —Å—á—ë—Ç: ${score}`;
    moves = 0;
    animating = true;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å–µ–¥—Å—Ç–≤–∞
function isNeighbor(a, b) {
    const ax = a % size, ay = Math.floor(a / size);
    const bx = b % size, by = Math.floor(b / size);
    return (Math.abs(ax - bx) + Math.abs(ay - by)) === 1;
}

// –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏
function swapCells(a, b) {
    [grid[a], grid[b]] = [grid[b], grid[a]];
}

// –ü–æ–∏—Å–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
function findMatches() {
    let matches = [];
    for (let y=0;y<size;y++){
        for (let x=0;x<size-2;x++){
            const i=y*size+x;
            if (grid[i]===grid[i+1] && grid[i]===grid[i+2]) matches.push(i,i+1,i+2);
        }
    }
    for (let x=0;x<size;x++){
        for (let y=0;y<size-2;y++){
            const i=y*size+x;
            if (grid[i]===grid[i+size] && grid[i]===grid[i+size*2]) matches.push(i,i+size,i+size*2);
        }
    }
    return [...new Set(matches)];
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
function processMatches() {
    let matches = findMatches();
    if (matches.length===0) { animating=false; return; }
    matches.forEach(i=>{grid[i]=null;document.querySelectorAll('.cell')[i].classList.add('match');});
    score+=matches.length*10;
    setTimeout(()=>{
        for (let x=0;x<size;x++){
            let col=[];
            for (let y=0;y<size;y++){
                const i=y*size+x;
                if(grid[i]!==null) col.push(grid[i]);
            }
            while(col.length<size) col.unshift(candies[Math.floor(Math.random()*candies.length)]);
            for (let y=0;y<size;y++) grid[y*size+x]=col[y];
        }
        render();
        setTimeout(processMatches,300);
    },300);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–∞–π–ø–æ–≤
function setupTouch() {
    const game = document.getElementById("game");
    game.addEventListener('touchstart', e=>{touchStart=e.touches[0];});
    game.addEventListener('touchend', e=>{
        if (!touchStart || moves<=0 || animating) return;
        const touchEnd = e.changedTouches[0];
        const dx = touchEnd.clientX - touchStart.clientX;
        const dy = touchEnd.clientY - touchStart.clientY;
        if(Math.abs(dx)<10 && Math.abs(dy)<10) return;

        const rect = game.getBoundingClientRect();
        const cellSize = rect.width/size;
        const startX = Math.floor((touchStart.clientX-rect.left)/cellSize);
        const startY = Math.floor((touchStart.clientY-rect.top)/cellSize);
        const endX = startX + (Math.abs(dx)>Math.abs(dy)?(dx>0?1:-1):0);
        const endY = startY + (Math.abs(dy)>Math.abs(dx)?(dy>0?1:-1):0);

        if(endX<0||endX>=size||endY<0||endY>=size) return;

        const a = startY*size+startX;
        const b = endY*size+endX;

        if(isNeighbor(a,b)){
            animating=true;
            animateSwap(a,b).then(()=>{
                if(findMatches().length>0){moves--;processMatches();}
                else animateSwap(a,b).then(()=>{animating=false;});
                updateInfo();
                if(moves<=0) endGame();
            });
        }
        touchStart=null;
    });
}

// –ê–Ω–∏–º–∞—Ü–∏—è —Å–º–µ–Ω—ã –º–µ—Å—Ç
function animateSwap(a,b){
    return new Promise(resolve=>{
        const cells=document.querySelectorAll('.cell');
        const cellA=cells[a],cellB=cells[b];
        const dx=cellB.offsetLeft-cellA.offsetLeft;
        const dy=cellB.offsetTop-cellA.offsetTop;
        cellA.classList.add('swap'); cellB.classList.add('swap');
        cellA.style.transform=`translate(${dx}px,${dy}px)`; 
        cellB.style.transform=`translate(${-dx}px,${-dy}px)`;
        setTimeout(()=>{
            cellA.style.transform=''; cellB.style.transform='';
            swapCells(a,b); render(); resolve();
        },300);
    });
}

init();
</script>

</body>
</html>